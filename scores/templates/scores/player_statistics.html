{% extends "scores/base.html" %}
{% load static %}

{% block content %}
<div class="container my-5">
  <h1 class="mb-4">Player Statistics</h1>

  {# --- Player Selection Dropdown (Unchanged) --- #}
  <form method="get" action="{% url 'player_statistics' %}" class="mb-4 row g-3 align-items-center">
    <div class="col-auto"><label for="player_id" class="col-form-label">Select Player:</label></div>
    <div class="col-auto">
      <select name="player_id" id="player_id" class="form-select">
        <option value="">-- Select a Player --</option>
        {% for player in players %}
          <option value="{{ player.id }}" {% if selected_player and selected_player.id == player.id %}selected{% endif %}>
            {{ player.name }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto"><button type="submit" class="btn btn-primary">View Stats</button></div>
  </form>

  {# --- Statistics Display Area --- #}
  {% if selected_player %}
    <hr>
    <h2 class="mb-3">Stats for: {{ selected_player.name }}</h2>

    {% if stats %}
      <div class="row">
        {# Overall Summary Card (Unchanged) #}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header">Overall Summary</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">Games Participated: <span class="badge bg-primary rounded-pill">{{ stats.games_participated|default:0 }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Total Cycles Played: <span class="badge bg-secondary rounded-pill">{{ stats.total_cycles|default:0 }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Total Rolls: <span class="badge bg-secondary rounded-pill">{{ stats.total_rolls|default:0 }}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Total Score: <span class="badge bg-success rounded-pill">{{ stats.total_score|default:0 }}</span></li>
                </ul>
            </div>
        </div>
        {# Averages Card (Unchanged) #}
        <div class="col-md-6 col-lg-4 mb-4">
             <div class="card h-100 shadow-sm"> <div class="card-header">Averages</div> <ul class="list-group list-group-flush"> <li class="list-group-item d-flex justify-content-between align-items-center"> Avg Score / Cycle: <span class="badge bg-info rounded-pill">{{ stats.avg_per_cycle|default:0|floatformat:2 }}</span> </li> <li class="list-group-item d-flex justify-content-between align-items-center"> Avg Score / Roll: <span class="badge bg-info rounded-pill">{{ stats.avg_per_roll|default:0|floatformat:2 }}</span> </li> </ul> </div>
        </div>
        {# High Scores Card (Unchanged) #}
        <div class="col-md-6 col-lg-4 mb-4">
             <div class="card h-100 shadow-sm"> <div class="card-header">High Scores</div> <ul class="list-group list-group-flush"> <li class="list-group-item d-flex justify-content-between align-items-center"> Highest Cycle Score: <span class="badge bg-warning text-dark rounded-pill">{{ stats.highest_cycle_score|default:"N/A" }}</span> </li> <li class="list-group-item d-flex justify-content-between align-items-center"> Highest Single Roll: <span class="badge bg-warning text-dark rounded-pill">{{ stats.highest_roll_score|default:"N/A" }}</span> </li> </ul> </div>
        </div>
        {# No-Balls Card (Unchanged) #}
        <div class="col-md-6 col-lg-4 mb-4">
             <div class="card h-100 shadow-sm"> <div class="card-header">"No-Balls" (Zeros)</div> <ul class="list-group list-group-flush"> <li class="list-group-item d-flex justify-content-between align-items-center"> Total Zero-Score Cycles: <span class="badge bg-danger rounded-pill">{{ stats.zero_cycle_count|default:0 }}</span> </li> <li class="list-group-item d-flex justify-content-between align-items-center"> Total Zero-Score Rolls: <span class="badge bg-danger rounded-pill">{{ stats.total_zero_rolls|default:0 }}</span> </li> <li class="list-group-item d-flex justify-content-between align-items-center"> Zero Roll %: <span class="badge bg-danger rounded-pill">{{ stats.zero_roll_percentage|default:0|floatformat:1 }}%</span> </li> </ul> </div>
        </div>
        {# Win/Loss Record Card (Unchanged) #}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm"> <div class="card-header">Record (When on 'Own' Team)</div> <ul class="list-group list-group-flush"> <li class="list-group-item d-flex justify-content-between align-items-center text-success"> Wins: <span class="badge bg-success rounded-pill">{{ stats.wins|default:0 }}</span> </li> <li class="list-group-item d-flex justify-content-between align-items-center text-danger"> Losses: <span class="badge bg-danger rounded-pill">{{ stats.losses|default:0 }}</span> </li> <li class="list-group-item d-flex justify-content-between align-items-center text-muted"> Draws: <span class="badge bg-secondary rounded-pill">{{ stats.draws|default:0 }}</span> </li> </ul> </div>
        </div>
      </div> {# End Row #}

      
      {# --- Performance Chart --- #}
      <div class="card mb-4 shadow-sm">
        <div class="card-header">
            {# MOVED COMMENTS OUTSIDE H3 #}
            {# Using h5 for slightly smaller heading on mobile #}
            {# Stack title/subtitle on extra-small screens #}
            <h3 class="mb-0 h5"> 
                Performance Over Time
                <small class="text-muted d-block d-sm-inline">(Avg Cycle Score per Game)</small>
            </h3>
        </div>
        <div class="card-body">
            {% if chart_data_json %}
              {# The container for the canvas. #}
              <div style="position: relative; width: 100%; height: auto; min-height: 250px;">
                 <canvas id="performanceChart"></canvas>
              </div>
            {% else %}
              <p class="text-center text-muted">Not enough game data to display performance trend.</p>
            {% endif %}
        </div>
      </div>
      {# --- End Performance Chart --- #}
      {# Improvement Trend Table (Optional - keep if you want table too) #}
      {# Improvement Trend Table #}
      <div class="card mb-4 shadow-sm">
        <div class="card-header">Game History (Avg Cycle Score)</div>
        <div class="card-body p-0">
          {% if stats.improvement_trend %}
          <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Game Date</th>
                  <th>Game Details</th> {# Changed Header #}
                  <th class="text-end">Average Score</th>
                </tr>
              </thead>
              <tbody>
                {% for game_stat in stats.improvement_trend %}
                  <tr>
                    <td>{{ game_stat.game__date|date:"Y-m-d" }}</td>
                    {# --- MODIFY THIS CELL --- #}
                    <td>
                      <a href="{% url 'game_statistics' game_id=game_stat.game__id %}">
                        vs {{ game_stat.game__opponent__name|default:"N/A" }}
                        at {{ game_stat.game__location__name|default:"N/A" }}
                      </a>
                    </td>
                    {# --- END MODIFICATION --- #}
                    <td class="text-end">{{ game_stat.game_avg|floatformat:2 }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="3" class="text-center text-muted p-3">No game history.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
            <p class="text-center text-muted p-3">No game history available.</p>
          {% endif %}
        </div>
      </div>

    {% else %} {# No stats calculated (e.g., player has no scores) #}
      <div class="alert alert-warning" role="alert">No score data found for {{ selected_player.name }}.</div>
    {% endif %} {# End if stats #}

  {% elif player_id %} {# Player ID given but player not found #}
      <div class="alert alert-danger" role="alert">Player with ID {{ player_id }} not found.</div>
  {% else %} {# Initial state #}
      <div class="alert alert-info" role="alert">Please select a player to view their statistics.</div>
  {% endif %} {# End if selected_player #}

</div> {# End container #}

{# ======================= Chart.js Script ======================= #}
{# Only include Chart.js and chart logic if data exists #}
{% if chart_data_json %}
  {# Include Chart.js library (e.g., from CDN) #}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  {# Include date adapter and Luxon (optional but recommended for time axis) #}
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.1.0/dist/chartjs-adapter-luxon.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('performanceChart');
      if (ctx) {
        // Parse the JSON data passed from the Django template
        // Use |safe filter to prevent auto-escaping of JSON string
        const chartData = JSON.parse('{{ chart_data_json|safe|escapejs }}');

        if (chartData && chartData.labels && chartData.data) {
            new Chart(ctx, {
                type: 'line', // Line chart for trend
                data: {
                    labels: chartData.labels, // Dates from view
                    datasets: [{
                        label: 'Avg Score per Cycle',
                        data: chartData.data, // Average scores from view
                        borderColor: 'rgb(75, 192, 192)', // Example color
                        tension: 0.1 // Slight curve to the line
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true, // Adjust as needed
                    scales: {
                        x: {
                            type: 'time', // Use time scale for dates
                            time: {
                                unit: 'day', // Adjust unit based on data density (day, month, year)
                                tooltipFormat: 'DD MMM yyyy', // Format for tooltips
                                displayFormats: {
                                   day: 'MMM d, yyyy' // Format for axis labels
                                }
                            },
                            title: {
                                display: true,
                                text: 'Game Date'
                            }
                        },
                        y: {
                            beginAtZero: true, // Start Y axis at 0
                            title: {
                                display: true,
                                text: 'Average Score per Cycle'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        },
                        title: {
                            display: true,
                            text: 'Player Performance Over Time'
                        }
                    }
                }
            });
        } else {
            console.warn("Chart data format invalid or missing.");
        }
      } else {
        console.warn("Canvas element 'performanceChart' not found.");
      }
    });
  </script>
{% endif %} {# End if chart_data_json #}
{# ======================= End Chart.js Script ======================= #}

{% endblock %}